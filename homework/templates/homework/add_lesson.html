{% load static %}
{% load homework_extras %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æˆæ¥­ç™»éŒ²</title>
    <link rel="stylesheet" href="{% static 'homework/style.css' %}">
</head>
<body>
    <p style="text-align: right;">
        <a href="{% url 'weekly_view' %}" class="back-button">â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</a>
    </p>
    <h1>æˆæ¥­ç™»éŒ²(â‘ ã€œâ‘¢)</h1>

    <form method="post" onsubmit="console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã•ã‚Œã¾ã—ãŸï¼');">
        {% csrf_token %}
    
        <!-- ğŸ”¥ hidden ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
        <input type="hidden" name="subject" id="id_subject">
        <input type="hidden" name="course" id="id_course">
        <input type="hidden" name="start_time" id="id_start_time">
        <input type="hidden" name="end_time" id="id_end_time">

        
        <h2>â‘ æˆæ¥­ã‚’é¸æŠ</h2>
        <div>
            {% for template in templates %}
            <div style="display:inline-block; margin:5px;">
                <button type="button" class="template-button"
                    data-subject="{{ template.subject.id }}"
                    data-course="{{ template.course.id }}"
                    data-start="{{ template.start_time }}"
                    data-end="{{ template.end_time }}">
                    ğŸ“ {{ template.subject.name }} / {{ template.course.name }}
                    {{ template.start_time|time:"H:i" }}ã€œ{{ template.end_time|time:"H:i" }}
                </button>
            
            </div>
            {% empty %}
                <p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        
            <!-- ğŸ”¥ ã“ã®éƒ¨åˆ†ã‚’è¿½åŠ ï¼ -->
            <div style="display:inline-block; margin:5px;">
                <a href="{% url 'add_lesson_template' %}" class="template-button" style="text-decoration: none;">
                    â• æˆæ¥­ã‚’æ–°è¦ä½œæˆorå‰Šé™¤
                </a>
            </div>
        </div>
        
        
        <h2>â‘¡è¿½åŠ ã—ãŸã„æˆæ¥­ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯(è¤‡æ•°æ—¥é¸ã¹ã¾ã™)</h2>
        
        
        <div class="calendar">
            {% for day in calendar_days %}

                
                <div class="day {% if day == today %}today{% endif %}" data-date="{{ day|date:'Y-m-d' }}">

                    {{ day|date:"m/d (D)" }}
                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º -->
                    {% for ev in events_by_day|get_item:day %}
                        <div style="background-color: #e0e0e0; font-size: 0.8em; margin: 2px 0;">
                            ğŸ“… {{ ev.name }}
                        </div>
                    {% endfor %}

                    <!-- ğŸ”¥ æˆæ¥­è¡¨ç¤º -->
                    {% for lesson in lessons_by_day|get_item:day %}
                    <div style="background-color: #ffe0b3; font-size: 0.8em; margin: 2px 0;">
                        æˆæ¥­ {{ lesson.subject.name }} / {{ lesson.course.name }}
                        {{ lesson.start_time|time:"H:i" }}ã€œ{{ lesson.end_time|time:"H:i" }}


                        <!-- âŒ JavaScriptã§å‰Šé™¤ -->
                        <button type="button"
                            onclick="submitDeleteLesson({{ lesson.id }})"
                            style="background: none; border: none; color: red; cursor: pointer; font-size: 0.8em; padding: 0;">
                            âŒ
                        </button>

                    </div>
                    {% endfor %}

                    <!-- å®¿é¡Œè¡¨ç¤º -->
                    {% for hw_entry in homeworks_by_day|get_item:day %}
                    <div class="homework-box subject-{{ hw_entry.detail.homework.subject }}">
                        {{ hw_entry.detail.homework.get_subject_display }}<br>
                        ğŸ« {{ hw_entry.detail.get_course_display }} / {{ hw_entry.detail.get_problem_type_display }}<br>
                        ğŸ“‹ {{ hw_entry.task }}
                    </div>
                    {% endfor %}



                </div>
                {% if forloop.counter|divisibleby:7 and not forloop.last %}
            </div><div class="calendar"> <!-- é€±ã”ã¨ã«æ–°ã—ã„è¡Œ -->
        {% endif %}
            {% endfor %}
        </div>

        <input type="hidden" name="selected_dates" id="selected_dates">
        
        
        <!-- ğŸ”¥ ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¿½åŠ  -->
        {% if form.errors %}
            <div style="color:red; margin-bottom:1rem;">
                {{ form.errors }}
            </div>
        {% endif %}
        
        <button type="submit" style="margin-top: 10px;">â‘¢ç™»éŒ²ã™ã‚‹</button>

    </form>

    <!-- ğŸ”¥ JSç”¨ã®éš ã‚Œå‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="delete-lesson-form" method="post" style="display: none;">
        {% csrf_token %}
    </form>


    <script>
    const days = document.querySelectorAll('.day');
    const selectedDatesInput = document.getElementById('selected_dates');
    const selectedDates = new Set();

    days.forEach(day => {
        day.addEventListener('click', () => {
            const isoDate = new Date(day.dataset.date).toISOString().split('T')[0];
            if (selectedDates.has(isoDate)) {
                selectedDates.delete(isoDate);
                day.classList.remove('selected');
            } else {
                selectedDates.add(isoDate);
                day.classList.add('selected');
            }
            selectedDatesInput.value = Array.from(selectedDates).join(',');
        });
    });


        const templateButtons = document.querySelectorAll('.template-button');
        templateButtons.forEach(button => {
            button.addEventListener('click', () => {
                // ğŸ”¥ ã“ã“ã§ä»–ã®ãƒœã‚¿ãƒ³ã®é¸æŠã‚¯ãƒ©ã‚¹ã‚’å¤–ã™
                templateButtons.forEach(btn => btn.classList.remove('selected'));
                // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒœã‚¿ãƒ³ã«é¸æŠã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹
                button.classList.add('selected');

                // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
                const subject = button.dataset.subject;
                const course = button.dataset.course;
                const start = button.dataset.start;
                const end = button.dataset.end;

                document.getElementById('id_subject').value = subject;
                document.getElementById('id_course').value = course;
                document.getElementById('id_start_time').value = start;
                document.getElementById('id_end_time').value = end;
            });
        });

        function submitDeleteLesson(lessonId) {
            if (!confirm('ã“ã®æˆæ¥­ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const form = document.getElementById('delete-lesson-form');

            form.action = `/homework/lesson/delete/${lessonId}/`;  // â† ä¿®æ­£æ¸ˆã¿
            form.submit();
        }

    </script>
</body>
</html>
