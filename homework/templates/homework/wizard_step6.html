{% extends 'homework/base.html' %}
{% load static %}
{% load homework_extras %}

{% block title %}宿題登録 Step 6{% endblock %}

<body class="text-6xl">
{% block content %}

<!-- ステップバー -->
<div class="arrow-steps">
  <div class="step done">1</div>
  <div class="step done">2</div>
  <div class="step done">3</div>
  <div class="step done">4</div>
  <div class="step done">5</div>
  <div class="step current">6</div>
  <div class="step">7</div>
</div>



{% if selected_subject or selected_course or selected_problem_type %}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    
    {% if selected_subject %}
    <div class="bg-white shadow-lg rounded-xl p-4 border border-gray-200">
      <div class="text-sm text-gray-500 mb-2">選択した科目</div>
      <div class="text-xl font-semibold text-green-600">
        {{ selected_subject.name }}
      </div>
    </div>
    {% endif %}

    {% if selected_course %}
    <div class="bg-white shadow-lg rounded-xl p-4 border border-gray-200">
      <div class="text-sm text-gray-500 mb-2">選択したコース</div>
      <div class="text-xl font-semibold text-blue-600">
        {{ selected_course.name }}
      </div>
    </div>
    {% endif %}

    {% if selected_problem_type %}
    <div class="bg-white shadow-lg rounded-xl p-4 border border-gray-200">
      <div class="text-sm text-gray-500 mb-2">選択した問題タイプ</div>
      <div class="text-xl font-semibold text-purple-600">
        {{ selected_problem_type.name }}
      </div>
    </div>
    {% endif %}



    {% if selected_count %}
    <div class="bg-white shadow-lg rounded-xl p-4 border border-gray-200">
      <div class="text-sm text-gray-500 mb-2">選択した問題数</div>
      <div class="text-xl font-semibold text-purple-600">
        {{ selected_count }}
      </div>
    </div>
    {% endif %}

    {% if cycles %}
    <div class="bg-white shadow-lg rounded-xl p-4 border border-gray-200">
      <div class="text-sm text-gray-500 mb-2">選択した周回数</div>
      <div class="text-xl font-semibold text-purple-600">
        {{ cycles }}周　＋　総復習
      </div>
    </div>
    {% endif %}

  </div>
{% endif %}




<h2 class="text-2xl my-6">⑥ 宿題をやる日を選択</h2>

<form method="post">
  {% csrf_token %}


  <input type="hidden" name="subject" value="{{ subject }}">
  <input type="hidden" name="course" value="{{ course }}">
  <input type="hidden" name="problem_type" value="{{ problem_type }}">
  <input type="hidden" name="problem_count" value="{{ problem_count }}">
  <input type="hidden" name="cycles" value="{{ cycles }}">
  <input type="hidden" name="selected_dates" id="selected_dates">

  <div class="calendar">
    {% for day in calendar_days %}
      <div class="day {% if day == today %}today{% endif %}" data-date="{{ day|date:'Y-m-d' }}">
        {{ day|date:"m/d (D)" }}

        {% for ev in events_by_day|get_item:day %}
          <div class="bg-yellow-100 text-sm">📅 {{ ev.name }}</div>
        {% endfor %}
        {% for lesson in lessons_by_day|get_item:day %}
          <div class="bg-orange-100 text-sm">
            {{ lesson.subject.name }}/{{ lesson.course.name }}
          </div>
        {% endfor %}
        {% for hw_entry in homeworks_by_day|get_item:day %}
          <div class="bg-blue-100 text-sm">
            📋 {{ hw_entry.task }}
          </div>
        {% endfor %}
      </div>
      {% if forloop.counter|divisibleby:7 and not forloop.last %}
      </div><div class="calendar">
      {% endif %}
    {% endfor %}
  </div>

  <div class="text-center mt-10">
    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white text-3xl font-bold py-4 px-8 rounded-xl shadow-lg">
      次へ →
    </button>
  </div>
</form>

<!-- 戻るボタン -->
<div class="mt-10 text-center">
  <a href="{% url 'homework_wizard_step5' %}" class="bg-green-400 hover:bg-green-600 text-white text-3xl font-bold py-4 px-8 rounded-xl shadow-lg inline-block">
    ← 戻る
  </a>
</div>

<script>
  const days = document.querySelectorAll('.day');
  const selectedDatesInput = document.getElementById('selected_dates');
  const selectedDates = new Set();

  days.forEach(day => {
    day.addEventListener('click', () => {
      const iso = new Date(day.dataset.date).toISOString().split('T')[0];
      if (selectedDates.has(iso)) {
        selectedDates.delete(iso);
        day.classList.remove('selected');
      } else {
        selectedDates.add(iso);
        day.classList.add('selected');
      }
      selectedDatesInput.value = Array.from(selectedDates).join(',');
    });
  });
</script>

{% endblock %}
</body>
