{% extends 'homework/base.html' %}
{% load homework_extras %}
{% block title %}é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼{% endblock %}
{% block content %}




{% if view_mode == "div" %}

<!-- ğŸ“± ã‚¹ãƒãƒ›ç”¨ ç¸¦è¡¨ç¤º -->
<!-- ğŸ”¼ ä¸Šéƒ¨ä½™ç™½ã‚’è¿½åŠ  -->

<!-- ğŸ”½ é€±ç§»å‹•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<!-- ğŸ“† é€±é€ã‚ŠãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div class="flex justify-between items-center my-8 mt-20">
  
  <form method="get" action="{% url 'weekly_view' %}">
    <input type="hidden" name="base_date" value="{{ prev_week_date }}">
    <input type="hidden" name="view_mode" value="{{ view_mode }}">
    <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded text-3xl">â† å‰</button>
  </form>
  <form method="get" action="{% url 'weekly_view' %}">
    <input type="hidden" name="base_date" value="{{ today|date:'Y-m-d' }}">
    <input type="hidden" name="view_mode" value="{{ view_mode }}">
    <button class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded text-3xl">ğŸ“… ä»Šæ—¥ã¸</button>
  </form>
  <form method="get" action="{% url 'weekly_view' %}">
    <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded text-3xl">æ¬¡ â†’</button>
  </form>
</div>

<div class="mt-5"></div>
<div class="flex flex-col gap-4">
  {% for day in week_days %}
  <div class="bg-white rounded-xl shadow p-4 border {% if day == today %}ring-2 ring-blue-400{% endif %}">
    
    <!-- ğŸ¨ æ—¥ä»˜ -->
    <div onclick="showScheduleModal('{{ day|date:'Y-m-d' }}')"
      class="text-5xl font-bold mb-2 cursor-pointer
        {% if day == today %}
            text-blue-800
        {% elif day|date:'w' == '6' %}
            text-red-600
        {% elif day|date:'w' == '0' %}
            text-blue-600
        {% else %}
            text-gray-700
        {% endif %}
        hover:bg-blue-100 hover:scale-105 hover:shadow-md transition-all duration-150 rounded"
  >
  {{ day|date:"m/d (D)" }}
  </div>


    <!-- ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆ -->
    {% for ev in events_by_day|get_item:day %}
    <div class="bg-yellow-100 rounded px-2 py-1 mb-1 text-5xl">
      ğŸ“… {{ ev.name }}
  
      <form method="post" action="{% url 'delete_event' ev.id %}?base_date={{ base_date|date:'Y-m-d' }}&view_mode={{ view_mode }}"
            class="mt-4 text-right"
            onsubmit="return confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
        {% csrf_token %}
        <button type="submit" 
                style="width: 50%;"
                class="bg-red-500 hover:bg-red-600 text-white text-3xl px-6 py-2 rounded mt-10 mb-4">
          âŒã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
        </button>
    </form>
    </div>
    
    {% endfor %}

    <!-- ğŸ“˜ æˆæ¥­ -->
    {% for lesson in lessons_by_day|get_item:day %}
    <div class="rounded px-2 py-2 mb-2 text-5xl {{ lesson.subject.name|subject_color_class }}">

      æˆæ¥­ğŸ“˜ {{ lesson.subject.name }} / {{ lesson.course.name }}ï¼ˆ{{ lesson.start_time|time:"H:i" }}ã€œ{{ lesson.end_time|time:"H:i" }})

    <form method="post" action="{% url 'delete_lesson' lesson.id %}?base_date={{ base_date|date:'Y-m-d' }}&view_mode={{ view_mode }}"
    class="mt-4 text-right"
    onsubmit="return confirm('ã“ã®æˆæ¥­ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
      {% csrf_token %}
      <button type="submit" 
      style="width: 50%;"
      class="bg-red-500 hover:bg-red-600 text-white text-3xl px-6 py-2 rounded mt-10 mb-4">
        âŒã“ã®æˆæ¥­ã‚’å‰Šé™¤
      </button>
    </form>
  </div>


    {% endfor %}

    <!-- ğŸ“‹ å®¿é¡Œ -->
    {% for hw_entry in homeworks_by_day|get_item:day %}
    <div class="bg-green-100 rounded px-2 py-1 mb-1 text-5xl">
      ğŸ“š {{ hw_entry.detail.homework.get_subject_display }}<br>
      ğŸ« {{ hw_entry.detail.get_course_display }}<br>
      ğŸ“‹ {{ hw_entry.task }}
      
  <!-- ğŸ”½ æ¨ªä¸¦ã³ã«ã™ã‚‹ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <!-- ğŸ”½ æ¨ªä¸¦ã³ã«ã™ã‚‹ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="flex flex-wrap gap-4 mt-4">
    <!-- å…¨ä½“å‰Šé™¤ -->
    <form method="post"
          action="{% url 'delete_homework' hw_entry.detail.homework.id %}?base_date={{ base_date|date:'Y-m-d' }}&view_mode={{ view_mode }}"
          class="mt-4 text-right"
          onsubmit="return confirm('ã“ã®å®¿é¡Œï¼ˆå…¨æ—¥åˆ†ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
      {% csrf_token %}
      <button type="submit" class="bg-red-500 hover:bg-red-600 text-white text-3xl px-6 py-2 rounded mb-4">
        âŒ ã“ã®å®¿é¡Œï¼ˆå…¨æ—¥åˆ†ï¼‰ã‚’å‰Šé™¤
      </button>
    </form>

    <!-- å½“æ—¥ã ã‘å‰Šé™¤ -->
    <form method="post"
          action="{% url 'delete_homework_line' hw_entry.detail.id day|date:'Y-m-d' %}?base_date={{ base_date|date:'Y-m-d' }}&view_mode={{ view_mode }}"
          class="mt-4 text-right"
          onsubmit="return confirm('ã“ã®æ—¥ã®å®¿é¡Œã ã‘ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
      {% csrf_token %}
      <button type="submit" class="bg-gray-500 hover:bg-gray-600 text-white text-3xl px-6 py-2 rounded">
        ğŸ—“ï¸ ã“ã®æ—¥ã®å®¿é¡Œã ã‘å‰Šé™¤
      </button>
    </form>
  </div>


    </div>
    {% endfor %}

    <!-- ğŸ”½ ã“ã“ã«è¿½åŠ  -->
    <div class="hidden modal-raw" id="modal-raw-{{ day|date:'Y-m-d' }}">
      <script type="application/json">
        {
          "events": [
            {% for ev in events_by_day|get_item:day %}
              { "name": "{{ ev.name }}" }{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          "lessons": [
            {% for lesson in lessons_by_day|get_item:day %}
              {
                "subject": "{{ lesson.subject.name }}",
                "course": "{{ lesson.course.name }}",
                "start_time": "{{ lesson.start_time|time:'H:i' }}",
                "end_time": "{{ lesson.end_time|time:'H:i' }}"
              }{% if not forloop.last %},{% endif %}
            {% endfor %}
          ],
          "homeworks": [
            {% for hw in homeworks_by_day|get_item:day %}
              {
                "subject": "{{ hw.detail.homework.get_subject_display }}",
                "course": "{{ hw.detail.get_course_display }}",
                "task": "{{ hw.task }}"
              }{% if not forloop.last %},{% endif %}
            {% endfor %}
          ]
        }
      </script>
    </div>

  </div>
  {% endfor %}
</div>
{% endif %}






<!-- ğŸ–¥ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºï¼ˆPCç”¨ï¼‰ -->
{% if view_mode != 'div' %}
<div class="calendar-page p-4">
  <h2 class="text-xl font-bold mb-4">ğŸ—“ï¸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ{{ view_mode }}ï¼‰</h2>

  <div class="top_calendar-wrapper">
    <table class="calendar-table w-full border border-gray-300 text-sm">
      <thead>
        <tr class="bg-gray-100">
          {% for day in weeks.0 %}
          <th class="border border-gray-300 px-2 py-1 text-center">{{ day|date:"D" }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for week in weeks %}
        <tr>
          {% for day in week %}
          <td
          class="
            calendar-cell border border-gray-200 align-top p-2 min-w-[10rem]
            break-words leading-relaxed cursor-pointer dropzone
            transition-all duration-150
            hover:bg-blue-100 hover:scale-105 hover:shadow-lg
            {% if day|date:'w' == '0' %} bg-blue-50{% elif day|date:'w' == '6' %} bg-red-50{% else %} bg-white{% endif %}
            {% if day == today %} bg-green-100 ring-2 ring-green-400 font-bold{% endif %}
          "
          data-date="{{ day|date:'Y-m-d' }}"
          onclick="showScheduleModal('{{ day|date:'Y-m-d' }}')"
        >
          <div class="text-xs font-bold text-center text-gray-700 mb-1">
            {{ day|date:"m/d" }}
          </div>


            {% for ev in events_by_day|get_item:day %}
            <div class="calendar-event text-blue-800 text-xs mb-1">
              ğŸ“… {{ ev.name }}
              <a href="{% url 'delete_event' ev.id %}" class="text-red-500 ml-1">âŒ</a>
            </div>
            {% endfor %}


            {% for lesson in lessons_by_day|get_item:day %}
            <div class="calendar-lesson bg-yellow-100 text-xs p-1 rounded mb-1">
              æˆæ¥­: {{ lesson.subject.name }} / {{ lesson.course.name }}<br>
              {{ lesson.start_time|time:"H:i" }}ã€œ{{ lesson.end_time|time:"H:i" }}
              <a href="{% url 'delete_lesson' lesson.id %}" class="text-red-500 text-sm">âŒ</a>
            </div>
            {% endfor %}


            {% for hw_entry in homeworks_by_day|get_item:day %}
            <div class="calendar-homework bg-green-50 border border-green-300 rounded p-1 mb-1 text-xs">
              <strong>{{ hw_entry.detail.homework.get_subject_display }}</strong><br>
              ğŸ« {{ hw_entry.detail.get_course_display }} / {{ hw_entry.detail.get_problem_type_display }}<br>
              ğŸ“‹ {{ hw_entry.task }}
              <form method="post" action="{% url 'delete_homework' hw_entry.detail.homework.id %}" class="inline">
                {% csrf_token %}
                <button type="submit" style="all: unset; cursor: pointer; color: red; font-size: 0.8em;">âŒ</button>

              </form>
            </div>
            {% endfor %}


          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}






<!-- ğŸ“Œ ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€Œï¼‹ã€ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="fab-container" class="fixed bottom-6 right-6 z-50 flex flex-col items-end space-y-3">
  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ›ãƒãƒ¼æ™‚è¡¨ç¤ºï¼‰ -->
  <div id="fab-menu" class="hidden flex flex-col items-end space-y-4">
    <a href="{% url 'homework_wizard_step1' %}"
       class="bg-green-500 hover:bg-green-600 text-white text-6xl font-bold px-6 py-4 rounded-xl shadow-lg">
      â• å®¿é¡Œã‚’è¿½åŠ 
    </a>
    <a href="{% url 'add_event_step1' %}"
       class="bg-yellow-500 hover:bg-yellow-600 text-white text-6xl font-bold px-6 py-4 rounded-xl shadow-lg">
      ğŸ—“ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    </a>
    <a href="{% url 'lesson_wizard_step1' %}"
       class="bg-red-500 hover:bg-red-600 text-white text-6xl font-bold px-6 py-4 rounded-xl shadow-lg">
      ğŸ“š æˆæ¥­ã‚’è¿½åŠ 
    </a>
  </div>

  <!-- ï¼‹ãƒœã‚¿ãƒ³ -->
  <button
    class="w-36 h-36 rounded-full bg-blue-500 text-white text-6xl shadow-lg flex items-center justify-center hover:bg-blue-600">
    ï¼‹
  </button>
</div>






<!-- ğŸ“… è¡¨ç¤ºåˆ‡æ›¿ FABï¼ˆå·¦ä¸Šï¼‰ -->
<div id="view-menu-container" class="fixed top-6 left-6 z-50 text-left">
  <!-- ãƒœã‚¿ãƒ³æœ¬ä½“ -->
  <button
    class="w-36 h-36 rounded-full bg-purple-500 text-white text-6xl shadow-lg flex items-center justify-center hover:bg-purple-600">
    â‰¡
  </button>

  <!-- ğŸ”½ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="view-menu" class="hidden mt-3 space-y-4">

    <form method="get" action="{% url 'weekly_view' %}">
      <input type="hidden" name="view_mode" value="5weeks">
      <button type="submit"
              style="font-size: 5rem;"
              class="block w-full bg-blue-500 hover:bg-blue-600 text-white text-9xl font-bold px-6 py-4 rounded-lg shadow">
        ğŸ“… PCç”¨5é€±è¡¨ç¤º
      </button>
    </form>

  </div>
</div>

  


  

<script>
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  // FABãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå³ä¸‹ã®ï¼‹ï¼‰
  const fabContainer = document.getElementById("fab-container");
  const fabMenu = document.getElementById("fab-menu");

  // è¡¨ç¤ºåˆ‡æ›¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆå·¦ä¸Šã®â‰¡ï¼‰
  const viewMenuContainer = document.getElementById("view-menu-container");
  const viewMenu = document.getElementById("view-menu");

  if (isMobile) {
    // ã‚¹ãƒãƒ›ï¼šã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼ˆãƒˆã‚°ãƒ«ï¼‰
    let fabOpen = false;
    fabContainer.addEventListener("click", () => {
      fabOpen = !fabOpen;
      fabMenu.classList.toggle("hidden", !fabOpen);
    });

    let viewOpen = false;
    viewMenuContainer.addEventListener("click", () => {
      viewOpen = !viewOpen;
      viewMenu.classList.toggle("hidden", !viewOpen);
    });

    // ä»»æ„ï¼šå¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener("click", (e) => {
      if (!fabContainer.contains(e.target)) {
        fabMenu.classList.add("hidden");
        fabOpen = false;
      }
      if (!viewMenuContainer.contains(e.target)) {
        viewMenu.classList.add("hidden");
        viewOpen = false;
      }
    });

  } else {
    // PCï¼šãƒ›ãƒãƒ¼ã§è¡¨ç¤ºãƒ»éè¡¨ç¤º
    fabContainer.addEventListener("mouseenter", () => {
      fabMenu.classList.remove("hidden");
    });
    fabContainer.addEventListener("mouseleave", () => {
      fabMenu.classList.add("hidden");
    });

    viewMenuContainer.addEventListener("mouseenter", () => {
      viewMenu.classList.remove("hidden");
    });
    viewMenuContainer.addEventListener("mouseleave", () => {
      viewMenu.classList.add("hidden");
    });
  }


  function showScheduleModal(dateStr) {
  const contentDiv = document.getElementById('modal-content');
  contentDiv.innerHTML = '';

  const dateObj = new Date(dateStr);
  const options = { month: 'numeric', day: 'numeric', weekday: 'short' };
  const localeDate = dateObj.toLocaleDateString('ja-JP', options);
  document.getElementById('modal-date').innerText = localeDate;

  const rawEl = document.getElementById('modal-raw-' + dateStr);
  if (!rawEl) {
    contentDiv.innerHTML = '<p class="text-gray-500">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  const data = JSON.parse(rawEl.querySelector('script').textContent);

  const createSection = (title, items, renderFunc) => {
    if (!items || items.length === 0) return '';
    return `
      <div class="bg-gray-50 border-l-4 border-blue-300 px-4 py-3 rounded mb-6 shadow">
        <h3 class="text-2xl font-bold mb-2">${title}</h3>
        <ul class="list-disc ml-6 space-y-1 text-lg">
          ${items.map(renderFunc).join('')}
        </ul>
      </div>
    `;
  };

  const eventHTML = createSection("ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆ", data.events, ev => `<li>${ev.name}</li>`);
  const lessonHTML = createSection("ğŸ“˜ æˆæ¥­", data.lessons, l =>
    `<li>${l.subject} / ${l.course}ï¼ˆ${l.start_time}ã€œ${l.end_time}ï¼‰</li>`
  );
  const homeworkHTML = createSection("ğŸ“‹ å®¿é¡Œ", data.homeworks, hw =>
    `<li>${hw.subject} / ${hw.course} / ${hw.task}</li>`
  );

  contentDiv.innerHTML = eventHTML + lessonHTML + homeworkHTML || '<p class="text-gray-500">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
  document.getElementById('schedule-modal').classList.remove('hidden');
}

function closeScheduleModal() {
  document.getElementById('schedule-modal').classList.add('hidden');
}

function printModalContent() {
  const modal = document.getElementById('schedule-modal');
  const content = modal.querySelector('#modal-content').innerHTML;
  const date = document.getElementById('modal-date').innerText;

  const printWindow = window.open('', '_blank');
  printWindow.document.open();
  printWindow.document.write(`
    <html>
      <head>
        <title>${date} ã®äºˆå®š</title>
        <style>
          body {
            font-family: sans-serif;
            padding: 2rem;
          }
          h1 {
            text-align: center;
            margin-bottom: 2rem;
          }
          ul {
            margin-left: 1.5rem;
          }
        </style>
      </head>
      <body>
        <h1>${date} ã®äºˆå®š</h1>
        ${content}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

</script>


<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ -->
<div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-lg p-6 w-[90%] max-w-3xl max-h-[80vh] overflow-y-auto">
    <h2 id="modal-date" class="text-3xl font-bold mb-6 text-center text-gray-800"></h2>
    <div id="modal-content" class="space-y-6 text-lg text-gray-800"></div>
    <div class="text-center mt-4 space-x-4">
      <button onclick="closeScheduleModal()" class="bg-gray-600 text-white px-6 py-3 rounded-full hover:bg-gray-700 text-xl shadow">
        âœ–ï¸ é–‰ã˜ã‚‹
      </button>
    </div>
      <div class="text-center mt-4 space-x-4">
      <button onclick="printModalContent()" class="bg-blue-600 text-white px-6 py-3 rounded-full hover:bg-blue-700 text-xl shadow">
        ğŸ–¨ï¸ å°åˆ·
      </button>
    </div>
  </div>
</div>

{% endblock %}