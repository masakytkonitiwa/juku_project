{% load static %}
{% load homework_extras %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å®¿é¡Œç™»éŒ²</title>
    <link rel="stylesheet" href="{% static 'homework/style.css' %}">
</head>
<body>
    <p style="text-align: right;">
        <a href="{% url 'weekly_view' %}" class="back-button">â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹</a>
    </p>

    <h1>å®¿é¡Œç™»éŒ²</h1>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="subject" id="id_subject">
        <input type="hidden" name="course" id="id_course">
        <input type="hidden" name="problem_type" id="id_problem_type">
        <input type="hidden" name="problem_count" id="id_problem_count">
        <input type="hidden" name="cycles" id="id_cycles">
        <input type="hidden" name="selected_dates" id="selected_dates">

        <h2>â‘  ç§‘ç›®ã‚’é¸æŠ</h2>

        <div class="button-group" id="subject-buttons">
            {% for template in homework_subject_templates %}
                <button type="button" class="subject-button" data-value="{{ template.id }}">
                    ğŸ“š {{ template.name }}
                </button>
            {% empty %}
                <p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç§‘ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        
            <!-- ğŸ”¥ ç§‘ç›®ã®è¿½åŠ ãƒœã‚¿ãƒ³ã‚‚åŒã˜è¦‹ãŸç›®ã« -->
            <a href="{% url 'homework_subject_template_list' %}" class="subject-button" style="text-decoration: none; display: inline-block;">
                â• ç§‘ç›®ã‚’è¿½åŠ ãƒ»å‰Šé™¤
            </a>
        </div>
        
 

        <h2>â‘¡ ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</h2>

        <div class="button-group" id="course-buttons">
            {% for course in homework_courses %}
                <button type="button" class="course-button" data-value="{{ course.name }}">
                    ğŸ« {{ course.name }}
                </button>
            {% empty %}
                <p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        
            <!-- ğŸ”¥ ã‚³ãƒ¼ã‚¹ã®è¿½åŠ ãƒœã‚¿ãƒ³ã‚‚åŒã˜è¦‹ãŸç›®ã« -->
            <a href="{% url 'homework_course_template_list' %}" class="course-button" style="text-decoration: none; display: inline-block;">
                â• ã‚³ãƒ¼ã‚¹ã‚’è¿½åŠ ãƒ»å‰Šé™¤
            </a>
        </div>
        
        



        <h2>â‘¢ å•é¡Œã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h2>

        <div class="button-group" id="problem-type-buttons">
            {% for pt in homework_problem_types %}
                <button type="button" class="problem-type-button" data-value="{{ pt.name }}">
                    ğŸ“„ {{ pt.name }}
                </button>
            {% empty %}
                <p>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å•é¡Œã‚¿ã‚¤ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endfor %}
        
            <a href="{% url 'homework_problem_type_template_list' %}" class="problem-type-button" style="text-decoration: none; display: inline-block;">
                â• å•é¡Œã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ ãƒ»å‰Šé™¤
            </a>
        </div>




        <h2>â‘£ å•é¡Œæ•°ã‚’é¸æŠ</h2>

        <div class="button-group" id="problem-count-buttons">
            {% for num in range_1_max %}
                <button type="button" class="problem-count-button" data-value="{{ num }}">
                    {{ num }}å•
                </button>
            {% endfor %}
        
            <a href="{% url 'homework_problem_count_setting' %}"
               class="problem-count-button"
               style="text-decoration: none; display: inline-block;">
                â• æœ€å¤§å•é¡Œæ•°ã‚’è¨­å®š
            </a>
        </div>



        <h2>ï¼• å‘¨å›ã‚’é¸æŠ</h2>
        <div id="cycle-buttons">
            <button type="button" class="cycle-button" data-value="1">1å‘¨ï¼‹ç·å¾©ç¿’</button>
            <button type="button" class="cycle-button" data-value="2">2å‘¨ï¼‹ç·å¾©ç¿’</button>
            <button type="button" class="cycle-button" data-value="3">3å‘¨ï¼‹ç·å¾©ç¿’</button>
        </div>

        <h2>ï¼– å®¿é¡Œã‚’ã‚„ã‚‹æ—¥ã‚’é¸æŠ</h2>
        <div class="calendar">
            {% for day in calendar_days %}
                <div class="day {% if day == today %}today{% endif %}" data-date="{{ day|date:'Y-m-d' }}">
                    {{ day|date:"m/d (D)" }}

                    {% for ev in events_by_day|get_item:day %}
                    <div style="background-color: #e0e0e0; font-size: 0.8em;">ğŸ“… {{ ev.name }}</div>
                    {% endfor %}

                    {% for lesson in lessons_by_day|get_item:day %}
                    <div style="background-color: #ffe0b3; font-size: 0.8em;">
                        æˆæ¥­ {{ lesson.subject.name }} / {{ lesson.course.name }}
                        {{ lesson.start_time|time:"H:i" }}ã€œ{{ lesson.end_time|time:"H:i" }}
                    </div>
                    {% endfor %}

                    {% for hw_entry in homeworks_by_day|get_item:day %}
                    <div style="background-color: #d0ebff; font-size: 0.8em;">
                        {{ hw_entry.detail.homework.get_subject_display }}<br>
                        å®¿é¡Œ {{ hw_entry.detail.get_course_display }} / {{ hw_entry.detail.get_problem_type_display }}<br>
                        ğŸ“‹ {{ hw_entry.task }}
                        <button type="button" onclick="submitDeleteHomework({{ hw_entry.detail.homework.id }})" style="background: none; border: none; color: red; font-size: 0.8em; cursor: pointer;">âŒ</button>
                    </div>
                    {% endfor %}
                </div>
                {% if forloop.counter|divisibleby:7 and not forloop.last %}
                </div><div class="calendar">
                {% endif %}
            {% endfor %}
        </div>

        <p style="text-align: center; margin-top: 20px;">
            <button type="submit">ï¼— ç™»éŒ²ã™ã‚‹</button>
        </p>
    </form>

    <!-- å‰Šé™¤ç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
    <form id="delete-homework-form" method="post" style="display: none;">
        {% csrf_token %}
    </form>

    <script>
        const days = document.querySelectorAll('.day');
        const selectedDatesInput = document.getElementById('selected_dates');
        const selectedDates = new Set();

        days.forEach(day => {
            day.addEventListener('click', () => {
                const iso = new Date(day.dataset.date).toISOString().split('T')[0];
                if (selectedDates.has(iso)) {
                    selectedDates.delete(iso);
                    day.classList.remove('selected');
                } else {
                    selectedDates.add(iso);
                    day.classList.add('selected');
                }
                selectedDatesInput.value = Array.from(selectedDates).join(',');
            });
        });

        function setupToggleButtons(buttons, inputId) {
            const input = document.getElementById(inputId);
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('selected')) {
                        button.classList.remove('selected');
                        input.value = '';
                    } else {
                        buttons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        input.value = button.dataset.value;
                    }
                });
            });
        }

        setupToggleButtons(document.querySelectorAll('.subject-button'), 'id_subject');
        setupToggleButtons(document.querySelectorAll('.course-button'), 'id_course');
        setupToggleButtons(document.querySelectorAll('.problem-type-button'), 'id_problem_type');
        setupToggleButtons(document.querySelectorAll('.problem-count-button'), 'id_problem_count');
        setupToggleButtons(document.querySelectorAll('.cycle-button'), 'id_cycles');

        function submitDeleteHomework(id) {
            if (!confirm('ã“ã®å®¿é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const form = document.getElementById('delete-homework-form');
            form.action = `/homework/delete/${id}/`;
            form.submit();
        }
    </script>
</body>
</html>
